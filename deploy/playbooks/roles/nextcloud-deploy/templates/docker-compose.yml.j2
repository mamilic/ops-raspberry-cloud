version: "3.8"


services:

  ##############
  ### NGINX ####
  ##############
  nginx:
    image: {{ NGINX_IMAGE }}:{{ NGINX_VERSION }}
    deploy:
      resources:
        limits:
          cpus: '4'
    depends_on:
      - nextcloud
    restart: always
    ports:
      - 80:80
      - {{ PORTS.NEXTCLOUD }}:{{ PORTS.NEXTCLOUD }}
    networks:
      - {{ NEXTCLOUD_NETWORK }}
    volumes:
      - {{ NEXTCLOUD_VOLUME }}:/var/www/html:ro
      - {{ NGINX_VOLUME }}/nginx.conf:/etc/nginx/nginx.conf:ro
      - {{ CERT_PATH }}:{{ CERT_PATH }}:ro


  ################
  ### MARIADB ####
  ################
  mariadb:
    image: {{ MARIADB_IMAGE }}:{{ MARIADB_VERSION }}
    command: --transaction-isolation=READ-COMMITTED --innodb-buffer-pool-size=1024M --innodb-io-capacity=4000 --innodb-buffer-pool-instances=8 --innodb-buffer-pool-chunk-size=128M --join-buffer-size=256K
    restart: always
    networks:
      - {{ NEXTCLOUD_NETWORK }}
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - {{ MARIADB_VOLUME }}:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD={{ MYSQL_ROOT_PASSWORD }}
      - MYSQL_PASSWORD={{ MYSQL_PASSWORD }}
      - MYSQL_DATABASE={{ MYSQL_DATABASE }}
      - MYSQL_USER={{ MYSQL_USER }}
      - MYSQL_HOST=mariadb


  #################
  ### NEXTCLOUD ###
  #################
  nextcloud:
    image: {{ NEXTCLOUD_IMAGE }}:{{ NEXTCLOUD_VERSION }}
    deploy:
      resources:
        limits:
          cpus: '4'
    depends_on:
      - mariadb
      - redis
    restart: always
    networks:
      - {{ NEXTCLOUD_NETWORK }}
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - {{ NEXTCLOUD_VOLUME }}:/var/www/html
      - {{ NEXTCLOUD_VOLUME }}/data:/var/www/html/data
      - {{ NEXTCLOUD_VOLUME }}/php-fpm.conf:/usr/local/etc/php/conf.d/custom-config.php:ro
      - {{ NEXTCLOUD_VOLUME }}/op-cache.conf:/usr/local/etc/php/conf.d/nextcloud-config.ini:ro
    environment:
      - MYSQL_PASSWORD={{ MYSQL_PASSWORD }}
      - MYSQL_DATABASE={{ MYSQL_DATABASE }}
      - MYSQL_USER={{ MYSQL_USER }}
      - MYSQL_HOST=mariadb
      - REDIS_HOST=redis

  ######################
  ### NEXTCLOUD-CRON ###
  ######################
  nextcloud-cron:
    image: {{ NEXTCLOUD_IMAGE }}:{{ NEXTCLOUD_VERSION }}
    restart: always
    networks:
      - {{ NEXTCLOUD_NETWORK }}
    volumes:
      - {{ NEXTCLOUD_VOLUME }}:/var/www/html
    entrypoint: /cron.sh
    depends_on:
      - mariadb
      - redis

  #############
  ### REDIS ###
  #############
  redis:
    image: {{ REDIS_IMAGE }}:{{ REDIS_VERSION }}
    command: --loglevel {{ LOGGING_LEVEL_REDIS_VALUES[LOGGING_LEVEL_NUMERIC] }}
    restart: always
    networks:
      - {{ NEXTCLOUD_NETWORK }}
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
       test: ["CMD", "redis-cli","ping"]


  #################
  ### COLLABORA ###
  #################
  collabora:
    image: {{ COLLABORA_IMAGE }}:{{ COLLABORA_VERSION }}
    depends_on:
      - nextcloud
    restart: always
    networks:
      - {{ NEXTCLOUD_NETWORK }}
    cap_add:
      - MKNOD
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - {{ COLLABORA_VOLUME }}/coolwsd.xml:/etc/coolwsd/coolwsd.xml
    environment:
      - DONT_GEN_SSL_CERT=true
      - domain=cloud.next.lan|192.168.2.192
      - password={{ COLLABORA_PASSWORD }}
      - username={{ COLLABORA_USERNAME }}
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
      - dictionaries=en_US

networks:
  {{ NEXTCLOUD_NETWORK }}:
    external: true